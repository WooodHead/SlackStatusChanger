<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>Preference</title>
  <link rel="stylesheet" href="./node_modules/bulma/css/bulma.css">
  <link rel="stylesheet" href="./preference.css">
</head>
<body>
  <div id="preference"></div>
  <script>
    const {ipcRenderer} = require('electron')
    const types = require('./store/types')
    const {Emoji} = require('emoji-mart-vue')
    const Vue = require('vue/dist/vue.common')
    const storage = require('electron-json-storage')
//    storage.get(types.STORAGE_DATA, (err, data) => {
//      if (err) return console.log(err)
//      console.log(data)
//    })
    // API token取得方法をREADMEに書いてリンク貼る
    new Vue({
      el: '#preference',
      template: `
      <div>
        <header class="Header">
          <div class="Header__Title">
            Preference
          </div>
          <div class="Menu">
            <span class="MenuItem"
              v-for="menu in menuItems"
              :class="{'-active': isSelectedMenu(menu.type)}"
              @click="selectMenu(menu.type)"
            >
              <Emoji :emoji="menu.emoji" :set="emojiSet"/>
              <span class="MenuItem__label">{{menu.label}}</span>
            </span>
          </div>
        </header>
        <section class="Contents">
          <div class="field">
            <label class="label Contents__Label">
              <Emoji emoji=":key:" :set="emojiSet" :size="20"/>
              <span>API token</span>
            </label>
            <div class="control">
              <input :value="apiToken" ref="tokenInput" class="input" type="text" placeholder="Input your API token">
            </div>
          </div>
          <div class="field is-clearfix">
            <button @click="saveToken" class="button is-info is-pulled-right">
              <Emoji emoji=":heavy_check_mark:" :set="emojiSet" :size="16"/>
              <span>&nbsp;&nbsp;Save</span>
            </button>
          </div>
        </section>
        
        <section class="Contents">
          <div class="field">
            <label class="label Contents__Label">
              <Emoji emoji=":smiley:" :set="emojiSet" :size="20"/>
              <span>Emoji Style</span>
            </label>
            <div class="EmojiStyle control">
              <label class="radio" v-for="emojiType in emojiSetList">
                <input type="radio" name="emojiSet" style="display: none;"
                  v-model="emojiSet"
                  :value="emojiType.value"
                >
                <div class="EmojiType">
                  <Emoji :size="20" emoji=":smiley:" :set="emojiType.value"/>
                  <span>&nbsp;{{emojiType.label}}</span>
                </div>
              </label>
            </div>
            <div class="EmojiStyle__Caution">
              This preference is only for display on app. <br> See Slack Preferences > Messages & Media > Emoji Style.
            </div>
          </div>
        </section>
        
        <section class="Contents">
          <div class="field">
            <label class="label Contents__Label">
              <Emoji emoji=":scroll:" :set="emojiSet" :size="20"/>
              <span>Preset</span>
            </label>
            <div class="PresetItem" v-for="item in preset">
              <div class="control has-icons-left has-icons-right">
                <input class="input is-medium PresetItem__Text" :value="item.status_text">
                <span class="icon is-left PresetItem__Emoji">
                  <Emoji :emoji="item.status_emoji" :set="emojiSet"/>
                </span>
                <span class="icon is-right PresetItem__Remove">
                  <Emoji emoji=":x:" :set="emojiSet" :size="16"/>
                </span>
              </div>
            </div>
            <div class="control is-clearfix" style="text-align: center;">
              <span class="icon is-large">
                <Emoji class="PresetItem__Add" emoji=":heavy_plus_sign:" :set="emojiSet"/>
              </span>
            </div>
          </div>
        </section>
      </div>
      `,
      data() {
        return {
          menuItems: [
            {
              label: 'Token',
              emoji: ':key:',
              type: 'token',
            },
            {
              label: 'Emoji',
              emoji: ':smiley:',
              type: 'emoji',
            },
            {
              label: 'Preset',
              emoji: ':scroll:',
              type: 'preset',
            },
          ],
          selectedMenu: 'token',
          apiToken: null,
          emojiSet: null,
          preset: [],
          emojiSetList: [
            {
              label: 'Apple',
              value: 'apple',
            },
            {
              label: 'Google',
              value: 'google',
            },
            {
              label: 'Twitter',
              value: 'twitter',
            },
            {
              label: 'Emoji One',
              value: 'emojione',
            },
          ],
        }
      },
      created() {
        storage.get(types.STORAGE_DATA, (err, data) => {
          if (err) return console.log(err)
          this.apiToken = data.apiToken
          this.emojiSet = data.emojiSet
          this.preset = data.preset
        })
      },
      watch: {
        emojiSet(newVal, oldVal) {
          if (!oldVal) return
          this.update({emojiSet: newVal})
        }
      },
      
      methods: {
        saveToken() {
          // Tokenの検証してから保存する
          // 検証が成功したら通知出す
          const apiToken = this.$refs.tokenInput.value
          this.update({apiToken})
        },
        
        update(payload) {
          ipcRenderer.send(types.UPDATE_PREFERENCE, payload)
        },
        
        isSelectedMenu(type) {
          return this.selectedMenu === type
        },
        selectMenu(type) {
          this.selectedMenu = type
        }
      },
      
      components: {
        Emoji
      }
    })
  </script>
</body>
</html>
